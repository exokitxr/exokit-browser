<!doctype html>
<html>
  <head>
    <!-- webaverse.com -->
    <meta http-equiv="origin-trial" content="AoHK2FPlHFz/r1ykSeYCdlFyz6D3YiU4+KJYjwp/pmHat22s6E9jIrKiRecn47AxQHvsP6Dh92/ByXG0Tcy9hwUAAABoeyJvcmlnaW4iOiJodHRwczovL3dlYmF2ZXJzZS5jb206NDQzIiwiZmVhdHVyZSI6IldlYlhSRGV2aWNlTTc2IiwiZXhwaXJ5IjoxNTcwMTg3NDMyLCJpc1N1YmRvbWFpbiI6dHJ1ZX0=">
    <!-- exokit.org -->
    <meta http-equiv="origin-trial" content="AspvaSU7F1Gbpa8q9JRNRNXFF+0+77C1xkxf1hkzJCrBI7Mmt/eG25QXLBn7lfzPsgrN5next8ZtIiCeGs6R4w8AAABleyJvcmlnaW4iOiJodHRwczovL2V4b2tpdC5vcmc6NDQzIiwiZmVhdHVyZSI6IldlYlhSRGV2aWNlTTc2IiwiZXhwaXJ5IjoxNTcxMTEyNjU0LCJpc1N1YmRvbWFpbiI6dHJ1ZX0=">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&display=swap" rel="stylesheet">
    <style>
* {
  box-sizing: border-box;
}
body {
  width: 100vw;
  height: 100vh;
  margin: 0;
  font-family: 'Open Sans';
  font-size: 12px;
  overflow: hidden;
}
a {
  cursor: pointer;
}
ul {
  margin: 0;
  padding: 0;
  list-style-type: none;
}
header {
  position: absolute;
  display: flex;
  top: 0;
  left: 0;
  width: 100vw;
  height: 50px;
  background-color: #000;
  align-items: center;
  z-index: 1;
}
header .icon {
  height: 50px;
  margin: 0 10px;
}
header .nav {
  display: flex;
  height: 100%;
  padding: 0 10px;
  justify-content: center;
  align-items: center;
  border-top: 3px solid transparent;
  border-bottom: 3px solid transparent;
  color: #FFF;
  font-size: 14px;
  text-decoration: none;
}
header .nav:hover, header .nav.open {
  border-bottom-color: #ef5350;
}
header .nav i {
  display: inline-block;
  padding: 0 7px;
  padding-top: 2px;
}
header > .wrap {
  display: flex;
  margin-left: auto;
}
.button {
  display: inline-block;
  margin-right: 15px;
  padding: 7px 15px;
  border-radius: 100px;
  color: #FFF;
  background-color: #455a64;
  text-decoration: none;
  user-select: none;
  cursor: pointer;
}
.button:hover {
  background-color: #37474f;
}
.button.highlight {
  background-color: #ef5350;
}
.button.highlight:hover {
  background-color: #d32f2f;
}
.button.alt {
  background-color: #4caf50;
}
.button.alt:hover {
  background-color: #2e7d32;
}
.multibutton {
  display: flex;
  margin-right: 15px;
}
.multibutton > .button {
  margin-right: 1px;
}
.multibutton > .button:not(:first-child) {
  border-top-left-radius: 0;
  border-bottom-left-radius: 0;
}
.multibutton > .button:not(:last-child) {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
header .popup {
  position: absolute;
  display: flex;
  flex-direction: column;
  top: 60px;
  right: 20px;
  width: 500px;
  padding: 20px;
  background-color: #444;
  border: 2px solid rgba(0,0,0,0.5);
  color: #FFF;

  display: none;
}
header .popup::before {
  position: absolute;
  top: -20px;
  right: 150px;
  border-width: 0 0 20px 20px;
  border-style: solid;
  border-color: transparent;
  border-bottom-color: #444;
  content: ''
}
header .close {
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 20px;
  color: #FFF;
  text-decoration: none;
}
header .popup h1 {
  display: flex;
  flex-direction: column;
  margin: 0;
  font-size: 50px;
  line-height: 55px;
  font-weight: 600;
  color: rgba(255,255,255,1);
}
header .popup strong {
  font-size: 14px;
  line-height: 1.1;
  color: #ef5350;
  text-transform: uppercase;
}
header .popup p {
  margin-top: 20px;
  margin-bottom: 40px;
  font-size: 20px;
  line-height: 30px;
  color: rgba(255,255,255,0.5);
}
header .popdown {
  flex-direction: column;
  padding: 20px;
  /* border: 2px solid rgba(0,0,0,0.5); */
  color: #FFF;
}
header.logged-in #login-button, header:not(.logged-in) #logout-button {
  display: none;
}
#login-popdown {
  position: absolute;
  top: 50px;
  left: 0;
  width: 100vw;
  padding: 30px;
  background-color: rgba(33,33,33,1);
  border-top: 2px solid #141414;
}
#login-popdown > form:not(.phase-1) > .phase-1-content {
  display: none;
}
#login-popdown > form:not(.phase-2) > .phase-2-content {
  display: none;
}
#subscribe-popdown {
  position: absolute;
  top: 50px;
  left: 0;
  width: 100vw;
  padding: 30px;
  background-color: rgba(33,33,33,1);
  border-top: 2px solid #141414;
}
#subscribe-popdown .plans {
  display: flex;
  margin-bottom: 20px;
}
#subscribe-popdown .plans .plan {
  display: flex;
  width: 180px;
  padding: 30px;
  margin: 10px;
  flex-direction: column;
  border: 2px solid;
  border-radius: 10px;
  color: #444;
  cursor: pointer;
  align-items: center;
}
#subscribe-popdown .plans .plan:hover {
  color: #666;
}
#subscribe-popdown .plans .plan.selected {
  color: #5c6bc0;
}
#subscribe-popdown .plans .plan i {
  margin-bottom: 10px;
  font-size: 70px;
}
#subscribe-popdown .plans .plan .wrap {
  display: flex;
  flex-direction: column;
}
/* #subscribe-popdown .plans h3 {
  margin: 0;
  font-size: 30px;
}
#subscribe-popdown .plans strong {
  margin-bottom: 10px;
  text-transform: uppercase;
}
#subscribe-popdown .plans p {
  margin: 0;
  line-height: 1.4;
} */
#developers-popdown {
  position: absolute;
  display: flex;
  top: 50px;
  left: 380px;
  width: 300px;
  background-color: #444;
}
header .popdown:not(.open) {
  display: none !important;
}
header .popdown ul {
  font-size: 14px;
  line-height: 2;
}
canvas {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background-color: #000;
}
    </style>
  </head>
  <body>
    <header id=header>
      <img class=icon src="icon.svg"/>
      <a class="nav" id="explore-dropdown">Explore</a>
      <a class="nav">Download</a>
      <a class="nav" id="developers-dropdown">Developers<i class="fal fa-chevron-down"></i></a>
      <div class=wrap>
        <div class=multibutton>
          <nav class="button" id="enter-2d-button">Enter 2D</nav>
          <nav class="button" id="enter-xr-button">Enter XR</nav>
        </div>
        <nav class="button highlight" id="login-button">Login</nav>
        <nav class="button highlight" id="logout-button">Log out</nav>
      </div>
      <div class="popdown" id="login-popdown">
        <form class="phase-1" id="login-form">
          <div class="phase-1-content">
            <input type=email placeholder="your@email.com" id="login-email">
            <input type="submit" value="Log in">
          </div>
          <div class="phase-2-content">
            <input type=text placeholder="Verification code" id="login-verification-code">
            <input type="submit" value="Verify">
          </div>
        </form>
      </div>
      <div class="popdown" id="developers-popdown">
        <ul>
          <li>CLI</li>
          <li>SDK</li>
        </ul>
      </div>
    </header>
    <div class=ui id=ui></div>
    <script src="https://kit.fontawesome.com/0735724151.js"></script>
    <script type=module>
let xrIframe = null;

navigator.serviceWorker.register(`sw.js`)
  .then(() => {
    if (navigator.serviceWorker.controller) {
      // nothing
    } else {
      window.location.reload();
    }
  })
  .then(() => import('/.d/https://web.exokit.org/src/index.js'))
  // .then(() => import('./exokit-web/src/index.js'))
  .then(() => {
    xrIframe = document.createElement('xr-iframe');
    xrIframe.src = 'app.html';
    document.body.appendChild(xrIframe);

    loginToken && xrIframe.postMessage({
      method: 'login',
      loginToken,
    });
    
    /* xrIframe.addEventListener('message', e => {
      console.log('index got message', e);
    }); */
    
    const enter2dButton = document.getElementById('enter-2d-button');
    enter2dButton.addEventListener('click', () => {
      xrIframe.postMessage({
        method: 'enter2d',
      });
    });
    const enterXrButton = document.getElementById('enter-xr-button');
    enterXrButton.addEventListener('click', () => {
      xrIframe.enterXr();
    });
  });

const LAMBDA_URLS = {
  login: `https://login.webaverse.com/`,
  token: `https://token.webaverse.com/token`,
  tokens: `https://token.webaverse.com/tokens`,
  coords: `https://token.webaverse.com/coords`,
  presence: `wss://presence.webaverse.com/`,
  browser: `https://browser.webaverse.com/`,
};

/* function parseQuery(s) {
  var query = {};
  var pairs = (s[0] === '?' ? s.substr(1) : s).split('&');
  for (var i = 0; i < pairs.length; i++) {
    var pair = pairs[i].split('=');
    query[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
  }
  return query;
}
function _randomString() {
  return Math.random().toString(36).replace(/[^a-z]+/g, '').substr(0, 5);
}

const header = document.getElementById('header');
const mode = (() => {
  switch (window.location.hash) {
    case '#sp': return 'sp';
    case '#mp': return 'mp';
    case '#map': return 'map';
    default: return null;
  }
})(); */

const loginButton = document.getElementById('login-button');
const loginPopdown = document.getElementById('login-popdown');
const loginForm = document.getElementById('login-form');
const loginEmail = document.getElementById('login-email');
const loginVerificationCode = document.getElementById('login-verification-code');
const logoutButton = document.getElementById('logout-button');
loginButton.onclick = () => {
  loginPopdown.classList.toggle('open');
};
logoutButton.onclick = () => {
  localStorage.removeItem('loginToken');

  loginToken = undefined;
  xrIframe && xrIframe.postMessage({
    method: 'login',
    loginToken,
  });
  header.classList.remove('logged-in');
};
loginForm.onsubmit = e => {
  e.preventDefault();

  if (loginForm.classList.contains('phase-1')) {
    // console.log('login 1', loginEmail.value);

    loginForm.classList.remove('phase-1');

    fetch(LAMBDA_URLS.login + `?email=${encodeURIComponent(loginEmail.value)}`, {
      method: 'POST',
    })
      .then(res => {
        if (res.status >= 200 && res.status < 300) {
          // console.log('login 2', loginEmail.value);

          loginForm.classList.add('phase-2');

          return res.blob();
        } else {
          throw new Error(`invalid status code: ${res.status}`);
        }
      })
      .catch(err => {
        console.warn(err);
      });
  } else if (loginForm.classList.contains('phase-2')) {
    // console.log('login 3', loginVerificationCode.value);

    fetch(LAMBDA_URLS.login + `?email=${loginEmail.value}&code=${encodeURIComponent(loginVerificationCode.value)}`, {
      method: 'POST',
    })
      .then(res => {
        if (res.status >= 200 && res.status < 300) {
          return res.json();
        } else {
          throw new Error(`invalid status code: ${res.status}`);
        }
      })
      .then(newLoginToken => {
        // console.log('login 4', newLoginToken);

        loginToken = newLoginToken;
        xrIframe && xrIframe.postMessage({
          method: 'login',
          loginToken,
        });
        localStorage.setItem('loginToken', JSON.stringify(loginToken));

        header.classList.add('logged-in');
        loginPopdown.classList.remove('open');
      })
      .catch(err => {
        console.warn(err);
      });
  }
};
let loginToken = localStorage.getItem('loginToken');
if (loginToken) {
  loginToken = JSON.parse(loginToken);

  // console.log('login token 1');

  fetch(LAMBDA_URLS.login + `?email=${encodeURIComponent(loginToken.email)}&token=${encodeURIComponent(loginToken.token)}`, {
    method: 'POST',
  })
    .then(res => {
      if (res.status >= 200 && res.status < 300) {
        return res.json();
      } else {
        throw new Error(`invalid status code: ${res.status}`);
      }
    })
    .then(() => {
      // console.log('login token 2');

      xrIframe && xrIframe.postMessage({
        method: 'login',
        loginToken,
      });
      header.classList.add('logged-in');
    })
    .catch(err => {
      console.warn(err);

      loginToken = undefined;
      localStorage.removeItem('loginToken');
    });
}

// const exploreLabel = document.getElementById('explore-label');
// const exploreContent = document.getElementById('explore-content');
const _getCoordsFromBindingUrl = bindingUrl => {
  const match = bindingUrl.match(/^\/\?c=(-?[0-9\.]+),(-?[0-9\.]+)$/);
  if (match) {
    const x = parseFloat(match[1]);
    const z = parseFloat(match[2]);
    if (isFinite(x) && isFinite(z)) {
      return [x, z];
    } else {
      return null;
    }
  } else {
    return null;
  }
};
const _makeElement = html => {
  const div = document.createElement('div');
  div.innerHTML = html;
  return div.children[0];
};
const _getAppType = mimeType => {
  if (/^img\//.test(mimeType)) {
    return 'image';
  } else if (/^audio\//.test(mimeType)) {
    return 'audio';
  } else if (/^video\//.test(mimeType)) {
    return 'video';
  } else if (/^model\//.test(mimeType)) {
    return 'model';
  } else if (/^text\/html\+webgl$/.test(mimeType)) {
    return 'webgl';
  } else if (/^text\/html$/.test(mimeType)) {
    return 'html';
  } else {
    return null;
  }
};
const _renderItems = items => {
  const el = _makeElement(`<ul>
    ${items.map((item, index) => {
      const {type} = item;
      const coords = _getCoordsFromBindingUrl(item.bindingUrl);
      return `<li>
        
        <a id=img-${index+1}><img src="skin.png"></a>
        <div class=tag>
        ${(() => {
            switch (_getAppType(item.type)) {
              case 'image': return `<i class="fal fa-image"></i>`;
              case 'audio': return `<i class="fal fa-volume-up"></i>`;
              case 'video': return `<i class="fal fa-film"></i>`;
              case 'model': return `<i class="fal fa-dice-d4"></i>`;
              case 'webgl': return `<i class="fal fa-gamepad"></i>`;
              case 'html':
              default: return `<i class="fal fa-link"></i>`;
            }
          })()}
        </div>
        <div class=wrap>
          <h3>
            <a class="a-content" href="${item.url}" id=name-${index+1}>${item.name}</a>
            <div class=controls>
              <a id=control-edit-${index+1}><i class="fal fa-pencil"></i></a>
              <a id=control-move-${index+1}><i class="fal fa-crosshairs"></i></a>
              <a id=control-delete-${index+1}><i class="fal fa-trash-alt"></i></a>
            </div>
          </h3>
          <p><a id=owner-${index+1}><i class="fas fa-user"></i> ${item.addr.slice(0, 12)}</a> ${coords ? `<a class="a-binding" href="/?c=${coords.join(',')}" id=binding-${index+1}>at ${coords.join(',')}</a>` : `<a class="a-binding" id=binding-${index+1}><i class="fas fa-map-marker"></i> not bound</a>`}</p>
        </div>
      </li>`;
    }).join('')}
  </ul>`);
  const aBindings = el.querySelectorAll('.a-binding');
  for (let i = 0; i < aBindings.length; i++) {
    const a = aBindings[i];
    a.onclick = e => {
      e.preventDefault();

      history.pushState({}, a.href, a.href);
      _updateCoord();
    };
  }
  return el;
};
const _renderGamers = gamers => {
  const el = _makeElement(`<ul>
    ${gamers.map(gamer => {
      const {coords} = gamer;
      return `<li>
        <a id=img><img src="skin.png"></a>
        <div class=wrap>
          <h3>
            <a class="a-content" href="${gamer.name}" id=name>${gamer.name}</a>
          </h3>
          <p><a class="a-binding" href="/?c=${coords.join(',')}" id=coord><i class="fas fa-map-marker"></i> at ${coords.join(',')}</a></p>
        </div>
      </li>`;
    }).join('')}
  </ul>`);
  const aBindings = el.querySelectorAll('.a-binding');
  for (let i = 0; i < aBindings.length; i++) {
    const a = aBindings[i];
    a.onclick = e => {
      e.preventDefault();

      history.pushState({}, a.href, a.href);
      _updateCoord();
    };
  }
  return el;
};
/* const _updateTabs = async () => {
  if (currentExploreTab === 1) {
    const c = renderer.vr.enabled ? renderer.vr.getCamera(camera) : camera;
    const coords = [Math.floor((c.position.x + PARCEL_SIZE/2)/PARCEL_SIZE), Math.floor((c.position.z + PARCEL_SIZE/2)/PARCEL_SIZE)];
    const u = `${LAMBDA_URLS.coords}/${coords[0]}/${coords[1]}`;

    explorePopdown.classList.add('loading');

    const items = await fetch(u)
      .then(res => res.json())
      .catch(err => {
        console.warn(err.stack);
      });

    exploreLabel.innerText = 'Nearby';
    exploreContent.innerHTML = '';
    exploreContent.appendChild(_renderItems(items));
    explorePopdown.classList.remove('loading');
  } else if (currentExploreTab === 2) {
    const u = `${LAMBDA_URLS.tokens}/${encodeURIComponent(loginToken.addr)}`;

    explorePopdown.classList.add('loading');

    const items = await fetch(u)
      .then(res => res.json())
      .catch(err => {
        console.warn(err.stack);
      });

    exploreLabel.innerText = 'Inventory';
    exploreContent.innerHTML = '';
    exploreContent.appendChild(_renderItems(items));
    explorePopdown.classList.remove('loading');
  } else if (currentExploreTab === 3) {
    exploreLabel.innerText = 'Gamers';
    exploreContent.innerHTML = '';
    exploreContent.appendChild(_renderGamers([{
      name: 'Avaer',
      coords: [1.234, 2.567],
    }]));
    explorePopdown.classList.remove('loading');
  } else if (currentExploreTab === 4) {
    exploreLabel.innerText = '';
    exploreContent.innerHTML = '';
    exploreContent.appendChild(_makeElement(`<div class=url>
      <input type="text" placeholder="https://" id=url-input>
      <a id=go><i class="fal fa-plus-square"></i></a>
    </div>`));
    explorePopdown.classList.remove('loading');
  } else {
    // nothing
  }
}; */

const developersDropdown = document.getElementById('developers-dropdown');
const developersPopdown = document.getElementById('developers-popdown');
developersDropdown.onclick = () => {
  developersDropdown.classList.toggle('open');
  developersPopdown.classList.toggle('open');
};

const uiEl = document.getElementById('ui');
fetch('interface.html')
  .then(res => res.text())
  .then(htmlString => {
    const dom = new DOMParser().parseFromString(htmlString, 'text/html');
    const {head, body} = dom;
    const headChildNodes = Array.from(head.childNodes);
    for (let i = 0; i < headChildNodes.length; i++) {
      if (headChildNodes[i] instanceof HTMLStyleElement) {
        document.head.appendChild(headChildNodes[i]);
      }
    }
    const bodyChildNodes = Array.from(body.childNodes);
    for (let i = 0; i < bodyChildNodes.length; i++) {
      console.log('append', i, bodyChildNodes.length, bodyChildNodes[i]);
      uiEl.appendChild(bodyChildNodes[i]);
    }
  });
    </script>
  </body>
</html>
